generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PUSAT
  FINANCE
  FINANCE_DC
  FINANCE_ALL
  MANAGER_PUSAT
  GUDANG
  STOKIS
  MITRA
  DC
}

enum StokisOrderStatus {
  PENDING_PUSAT
  PO_ISSUED
  PROCESSING
  SHIPPED
  RECEIVED
  CANCELLED
}

enum MitraOrderStatus {
  PENDING
  APPROVED
  PROCESSING
  SHIPPED
  RECEIVED
  CANCELLED
}

model User {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  password    String
  phone       String?
  role        Role
  address     String?
  province    String?  // Province for unique code generation (e.g., "Jawa Barat")
  uniqueCode  String?  @unique // Unique code (e.g., "MTR-JABAR-001")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Mitra belongs to a Stokis
  stokisId    String?
  stokis      User?    @relation("MitraToStokis", fields: [stokisId], references: [id])
  mitras      User[]   @relation("MitraToStokis")

  // DC Area assignment (for STOKIS, FINANCE_DC)
  dcId        String?
  dc          User?    @relation("UserToDC", fields: [dcId], references: [id])
  dcMembers   User[]   @relation("UserToDC")

  // Gudang assignment
  gudangId    String?
  gudang      Gudang?  @relation(fields: [gudangId], references: [id])

  // Orders
  stokisOrders        StokisOrder[]  @relation("StokisOrders")
  mitraOrdersAsMitra  MitraOrder[]   @relation("MitraOrders")
  mitraOrdersAsStokis MitraOrder[]   @relation("StokisForMitraOrders")

  // Inventory
  inventories Inventory[]
  
  // Push Subscriptions
  pushSubscriptions PushSubscription[]

  // Custom Prices
  stokisPrices      StokisPrice[]

  // Multi-Stokis assignment (junction)
  mitraStokisLinks  MitraStokis[] @relation("MitraStokisLinks")
  stokisMitraLinks  MitraStokis[] @relation("StokisMitraLinks")
}

// Push Notification Subscriptions
model PushSubscription {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription String   @db.Text
  createdAt    DateTime @default(now())

  @@unique([userId, subscription])
}

model Gudang {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  address     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  users       User[]
  products    Product[]
}

model Product {
  id          String   @id @default(cuid())
  name        String
  sku         String   @unique
  unit        String   // pcs, kg, box
  price       Decimal  @db.Decimal(12, 2)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  gudangId    String
  gudang      Gudang   @relation(fields: [gudangId], references: [id])

  inventories         Inventory[]
  stokisOrderItems    StokisOrderItem[]
  mitraOrderItems     MitraOrderItem[]
  stokisPrices        StokisPrice[]
}

model Inventory {
  id          String   @id @default(cuid())
  quantity    Int      @default(0)
  updatedAt   DateTime @updatedAt

  userId      String
  user        User     @relation(fields: [userId], references: [id])
  productId   String
  product     Product  @relation(fields: [productId], references: [id])

  @@unique([userId, productId])
}

// Order from Stokis to Pusat
model StokisOrder {
  id          String            @id @default(cuid())
  orderNumber String            @unique
  status      StokisOrderStatus @default(PENDING_PUSAT)
  totalAmount Decimal           @db.Decimal(12, 2)
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Timestamps for each status
  pusatApproveAt   DateTime?
  financeApproveAt DateTime?
  poIssuedAt       DateTime?
  shippedAt        DateTime?
  receivedAt       DateTime?

  // Approval tracking
  approvedBy       String?   // User ID yang melakukan approval
  approvedByName   String?   // Nama user yang approve

  stokisId    String
  stokis      User              @relation("StokisOrders", fields: [stokisId], references: [id])
  items       StokisOrderItem[]
  invoice     Invoice?
}

// Invoice for Stokis Orders
enum InvoiceStatus {
  UNPAID
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  TRANSFER_BCA
  TRANSFER_MANDIRI
  TRANSFER_BRI
  CASH
  OTHER
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  orderId       String        @unique
  order         StokisOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  amount        Decimal       @db.Decimal(12, 2)
  dueDate       DateTime
  paidAt        DateTime?
  status        InvoiceStatus @default(UNPAID)
  paidAmount    Decimal       @db.Decimal(12, 2) @default(0) // Track partial payments
  
  payments      Payment[]     // Relation to payments
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Payment {
  id            String        @id @default(cuid())
  invoiceId     String
  invoice       Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  amount        Decimal       @db.Decimal(12, 2)
  paymentDate   DateTime
  method        PaymentMethod
  proofImage    String?       // URL or base64 of uploaded proof
  notes         String?
  
  createdAt     DateTime      @default(now())
  createdBy     String        // User ID of Finance who created this
  
  @@index([invoiceId])
}

model StokisOrderItem {
  id          String   @id @default(cuid())
  quantity    Int
  price       Decimal  @db.Decimal(12, 2)

  orderId     String
  order       StokisOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product     @relation(fields: [productId], references: [id])
}

// Order from Mitra to Stokis
model MitraOrder {
  id          String           @id @default(cuid())
  orderNumber String           @unique
  status      MitraOrderStatus @default(PENDING)
  totalAmount Decimal          @db.Decimal(12, 2)
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  approvedAt  DateTime?
  shippedAt   DateTime?
  receivedAt  DateTime?

  mitraId     String
  mitra       User             @relation("MitraOrders", fields: [mitraId], references: [id])
  stokisId    String
  stokis      User             @relation("StokisForMitraOrders", fields: [stokisId], references: [id])
  items       MitraOrderItem[]
}

model MitraOrderItem {
  id          String   @id @default(cuid())
  quantity    Int
  price       Decimal  @db.Decimal(12, 2)

  orderId     String
  order       MitraOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product    @relation(fields: [productId], references: [id])
}

model StokisPrice {
  id          String   @id @default(cuid())
  stokisId    String
  stokis      User     @relation(fields: [stokisId], references: [id])
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  customPrice Decimal  @db.Decimal(12, 2)
  updatedAt   DateTime @updatedAt

  @@unique([stokisId, productId])
}

// Junction table: Mitra can be assigned to multiple Stokis
model MitraStokis {
  id        String   @id @default(cuid())
  mitraId   String
  mitra     User     @relation("MitraStokisLinks", fields: [mitraId], references: [id])
  stokisId  String
  stokis    User     @relation("StokisMitraLinks", fields: [stokisId], references: [id])
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([mitraId, stokisId])
}
